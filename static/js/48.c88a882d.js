(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{"./src/replay/components/player/VideoStreamer/HlsjsVideoStreamer/HlsjsVideoStreamer.js":function(e,t,r){"use strict";r.r(t);var n=r("./src/replay/components/player/VideoStreamer/common/createVideoStreamerComponent.js"),a=r("./node_modules/hls.js/dist/hls.js"),i=r.n(a),s=r("./src/replay/components/player/VideoStreamer/types.js");function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e,t){const r=e.hls;r&&e.subscribers.forEach(e=>e(r,t))}const u=["DEBUG","VERBOSE","INFO"];function d(e,t,r){return new Promise((n,a)=>{if(i.a.isSupported()){const a=r&&r.hlsjs&&r.hlsjs.customConfiguration,s=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){l(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({autoStartLoad:!1,debug:r&&u.indexOf(r.logLevel)>=0},a),c=t&&t.licenseUrl;if(c){s.widevineLicenseUrl=c,s.emeEnabled=!0;const e=t&&t.licenseAcquisitionDetails;if(e&&e.robustness&&e.robustness["com.widevine.alpha"]){const t=e.robustness["com.widevine.alpha"],r=t.audio,n=t.video;s.drmSystemOptions={audioRobustness:r,videoRobustness:n}}}const d=new i.a(s);d.on(i.a.Events.MEDIA_ATTACHED,()=>{n(d)}),d.attachMedia(e)}else a(new s.a("STREAM_ERROR_TECHNOLOGY_UNSUPPORTED","hlsjs","Hls.js is not supported in this browser."))})}function f(e){const t=e.hls;return t?(t.stopLoad(),c(e,"off"),Promise.resolve(t.destroy())):Promise.resolve()}const p=new Date(0);var v=(e,t,r)=>{const n=r&&r.liveEdgeMargin||10;let a,s,o=0,l=!1;function c(){a=null,o=0,l=!1}const u={[i.a.Events.MANIFEST_LOADING]:()=>c,[i.a.Events.LEVEL_LOADED]:(e,t)=>{l=t.details.live,o=t.details.totalduration;const r=t.details&&t.details.fragments&&t.details.fragments[0]&&t.details.fragments[0].programDateTime;r&&(a=new Date(r))}};return t.subscribers.push((function(e,t){Object.entries(u).forEach(([r,n])=>{e[t](r,n),"on"===t&&(s=e)})})),{adjustForDvrStartOffset:function(){},calculateNewState:function(){let t;t=o&&l?Math.max((e.currentTime||0)-Math.max(e.duration-o,0),0):e.currentTime||0;const r=l&&o||e.duration,i=function(e,t,r){if(t instanceof Date&&!isNaN(t))return{absolutePosition:new Date(t.getTime()+1e3*r),absoluteStartPosition:t};if(e){const e=new Date,t=new Date(e.getTime()-1e3*r);return{absolutePosition:e,absoluteStartPosition:t}}return{absolutePosition:p,absoluteStartPosition:p}}(l,a,t),c=i.absolutePosition,u=i.absoluteStartPosition;return{position:t,duration:r,playMode:function(e,t){return t?e===1/0||0===e||e<100?"live":"livedvr":"ondemand"}(r,l),isAtLiveEdge:s&&function(e,t,r,n){return!!r&&(e.liveSyncPosition?t.currentTime>e.liveSyncPosition-n:e.config&&e.config.liveSyncDuration?t.currentTime>t.duration-(e.config.liveSyncDuration+n):!(!e.config||!e.config.liveSyncDurationCount)&&t.currentTime>t.duration-(10*e.config.liveSyncDurationCount+n))}(s,e,l,n),absolutePosition:c,absoluteStartPosition:u}},setPosition:function(t){isNaN(t)||t===1/0||isNaN(e.duration)||e.duration===1/0||(e.currentTime=o&&l?t+e.duration-o:t)},gotoLive:function(){l&&s&&(s.liveSyncPosition?e.currentTime=s.liveSyncPosition:s.config&&s.config.liveSyncDuration?e.currentTime=e.duration-(s.config.liveSyncDuration+n):s.config&&s.config.liveSyncDurationCount?e.currentTime=e.duration-(10*s.config.liveSyncDurationCount+n):e.currentTime=e.duration-n)}}},E=r("./src/replay/components/player/VideoStreamer/common/sourceNormalizer.js");var m=e=>(t,r)=>{const n=e.videoElement;f(e);const a=Object(E.a)(t.source);return a?d(n,a,t.configuration).then(t=>(e.hls=t,c(e,"on"),new Promise((e,r)=>{const n=()=>{t.off(i.a.Events.MANIFEST_PARSED,n);try{a.startPosition?t.startLoad(a.startPosition):t.startLoad(),e()}catch(o){r(new s.a("STREAM_ERROR","hlsjs","Stream load start failed.","FATAL",o))}};try{t.on(i.a.Events.MANIFEST_PARSED,n),t.loadSource(a.streamUrl)}catch(o){r(new s.a("STREAM_ERROR","hlsjs","Stream load failed.","FATAL",o))}}))):Promise.resolve()},g=r("./src/replay/components/player/VideoStreamer/common/filteredStreamStateUpdater.js"),b=r("./src/replay/components/player/VideoStreamer/common/propertyApplier.js"),T=r("./src/replay/components/player/VideoStreamer/common/playbackLifeCycleManager.js"),k=r("./src/replay/components/player/VideoStreamer/common/renderers.js"),h=r("./src/replay/components/player/VideoStreamer/common/logger.js");const S=(e,t)=>!e&&!t||e===t,y=(e,t)=>!e||!t||e===t;var R=(e,t)=>{let r,n=[];function a(){if(r){const e=(e=>{const t=[];return e?e.filter(e=>{const r="".concat(e.lang||"","!").concat(e.name||""),n=t.indexOf(r)<0;return n&&t.push(r),n}).map(e=>({id:e.id,language:e.lang||"unknown",kind:"",label:e.name||"unknown",origin:"in-stream"})):[]})(r.audioTracks);((e,t)=>{if(e.length===t.length){for(let r=0;r<e.length;r++)if(!S(e[r].id,t[r].id)||!S(e[r].language,t[r].language)||!S(e[r].label,t[r].label))return!0;return!1}return!0})(e,n)&&(n=e)}}function s(){let e=null;if(r){const t=r.audioTracks.filter(e=>e.id===r.audioTrack)[0];if(t){const r=t.name,a=t.lang;e=n.filter(({label:e,language:t})=>e===r&&t===a)[0]}}t({audioTracks:n,currentAudioTrack:e})}function o(){a(),s()}function l(){n=[]}const c={[i.a.Events.MANIFEST_LOADING]:()=>l,[i.a.Events.MANIFEST_PARSED]:o,[i.a.Events.AUDIO_TRACK_SWITCHED]:function(){a(),s()}};return e.subscribers.push((function(e,t){Object.entries(c).forEach(([n,a])=>{e[t](n,a),"on"===t&&(r=e)})})),{cleanup:()=>{},handleSourceChange:function(){o()},handleSelectedAudioTrackChange:function(e){const t=e;if(r&&r.audioTracks&&t){const e=(r.audioTracks[r.audioTrack]||{}).groupId,n=r.audioTracks.filter(r=>y(r.groupId,e)&&y(r.name,t.label)&&y(r.lang,t.language))[0];n&&(r.audioTrack=n.id)}}}},O=r("./src/replay/components/common.js");const A=["disabled","hidden","showing"];function L(e){const t=e.mode;return"number"===typeof t?A[t]:t}function D(e,t){e.mode="number"===typeof e.mode?A.indexOf(t):t}function P(e,t){return Number.isNaN(e)&&Number.isNaN(t)||null==e&&null==t||e===t}function _(e,t,r){return{id:e,kind:r.kind||"",label:r.label||"",language:r.language||"",origin:t}}var w=(e,t,r,n)=>{let a=[],i=null,s=T.b,o=0;const l=window.VTTCue||window.TextTrackCue;function c(){i=a.filter(e=>null!=e.videoElementTrack&&"showing"===L(e.videoElementTrack)).map(e=>e.selectableTrack)[0];const e=a.filter(e=>e.selectableTrack).map(e=>e.selectableTrack);Object(O.i)(e,s)?r({currentTextTrack:i,textTracks:s}):(s=e,r({currentTextTrack:i,textTracks:e}))}function u(t){if(Array.isArray(t)){e.textTracks.removeEventListener("addtrack",p),e.textTracks.removeEventListener("removetrack",v);const r=t.filter(e=>{const t=a.filter(t=>function(e,t){if(e&&t){if(e.cues&&t.cues){const r=e.cues,n=t.cues;if(r.length===n.length){if(r.filter((e,t)=>e.start===n[t].start&&e.end===n[t].end&&e.content===n[t].content).length!==r.length)return!1}}return P(e.language,t.language)&&P(e.kind,t.kind)&&P(e.label,t.label)&&P(e.src,t.src)}return P(e,t)}(t.sourceTrack,e)&&!t.isBlacklisted);if(0===t.length)return!0;{const r=t[0];return r.sourceTrack=e,r.isBlacklisted=!1,r.isLoaded=!0,!1}}).map(t=>{const r=++o;if(Array.isArray(t.cues)){const n=t.cues,a=e.addTextTrack("subtitles",t.label,t.language);return n.forEach(e=>{a.addCue(new l(e.start,e.end,e.content))}),{id:r,sourceTrack:t,isBlacklisted:!1,videoElementTrack:a,selectableTrack:_(r,"side-loaded",a),loadPromise:Promise.resolve(a),isLoaded:!0}}{const e={src:t.src,srclang:t.language,kind:t.kind||"subtitles",label:t.label},n=new Promise(t=>{e.onRef=e=>{const r=e;if(r){D(r.track,"hidden");const e=()=>{r.removeEventListener("load",e),r.removeEventListener("error",n),t(r.track)},n=a=>{r.removeEventListener("load",e),r.removeEventListener("error",n),t()};r.addEventListener("load",e),r.addEventListener("error",n)}}}),a={id:r,sourceTrack:t,isBlacklisted:!1,videoElementTrack:void 0,selectableTrack:void 0,trackElementData:e,loadPromise:n,isLoaded:!1};return n.then(e=>{null!=e&&(a.videoElementTrack=e,a.selectableTrack=_(r,"side-loaded",e)),a.isLoaded=!0}),a}});return a=a.concat(r),n(a.filter(e=>e.trackElementData&&!e.isBlacklisted).map(e=>e.trackElementData)),Promise.all(r.map(e=>e.loadPromise)).then(()=>{e.textTracks.addEventListener("addtrack",p),e.textTracks.addEventListener("removetrack",v),c()})}return Promise.resolve()}function d(e){if(0===e.length&&0===a.length)return;const t=[];for(let n=0;n<e.length;n++)t.push(e[n]);const r=a.filter(e=>t.indexOf(e.videoElementTrack)>=0);if(t.length>r.length){const e=t.filter(e=>{return("metadata"!==(t=e).kind&&!("inBandMetadataTrackDispatchType"in t)||t.cues&&t.cues.length||t.label||t.language)&&0===r.filter((function(t){return e===t.videoElementTrack})).length;var t}).map(e=>{const t=++o;return{id:t,sourceTrack:null,videoElementTrack:e,isBlacklisted:!1,selectableTrack:_(t,"in-stream",e),isLoaded:!0}});a=r.concat(e)}else a=r}function f(t){d(e.textTracks),a.forEach(e=>{if((t||null!=e.sourceTrack)&&(e.isBlacklisted=!0),null!=e.videoElementTrack&&t){const t=e.videoElementTrack;if(t.cues)for(;t.cues.length;)t.removeCue(t.cues[0]);D(t,"disabled")}e.selectableTrack=null}),s=T.b,n([])}function p(){d(e.textTracks),c()}function v(){d(e.textTracks),c()}return e.textTracks.addEventListener("addtrack",p),e.textTracks.addEventListener("removetrack",v),{handleSelectedTextTrackChange:function(e){if(a.filter(e=>e.videoElementTrack&&"showing"===L(e.videoElementTrack)).forEach(e=>e.videoElementTrack&&D(e.videoElementTrack,"hidden")),e){t.hls&&(t.hls.subtitleDisplay=!0);const r=a.filter(t=>t.selectableTrack===e)[0];r&&r.videoElementTrack&&D(r.videoElementTrack,"showing")}else t.hls&&(t.hls.subtitleDisplay=!1);c()},handleTextTracksPropChange:function(e){f(!1),u(e.source&&Array.isArray(e.textTracks)?e.textTracks:[])},handleSourcePropChange:function(t){d(e.textTracks);const r=t.source&&Array.isArray(t.textTracks)?t.textTracks:[],n=Object(E.a)(t.source);n&&n.textTracks?u(r.concat(n.textTracks)):u(r)},clear:function(){f(!0)},cleanup:function(){e.textTracks.removeEventListener("addtrack",p),e.textTracks.removeEventListener("removetrack",v)}}};function j(e){return e&&Math.ceil(e.bitrate/1e3)||0}var x=(e,t,r,n)=>{let a,s=[];function o(e,t){if(a){let o=Array.isArray(a.levels)?a.levels.map(j):[];Object(O.i)(s,o)&&(o=s);const l=e===i.a.Events.LEVEL_SWITCHED?t.level:-1===a.currentLevel?a.startLevel:a.currentLevel;if(-1===l)n&&n("No hls.js level reported currently or selected for start."),r({bitrates:o});else{const e=j(a.levels[l]);r({currentBitrate:e,bitrates:o})}}}const l={[i.a.Events.MANIFEST_LOADING]:()=>{s=[]},[i.a.Events.MANIFEST_PARSED]:o,[i.a.Events.LEVEL_SWITCHED]:o,[i.a.Events.LEVEL_UPDATED]:o};return t.subscribers.push((function(e,t){Object.entries(l).forEach(([r,n])=>{e[t](r,n),"on"===t&&(a=e)})})),{fixBitrate:function(e){if(a)if("min"===e)Array.isArray(a.levels)&&a.levels.length>0&&(a.nextLevel=0,r({bitrateFix:j(a.levels[0])}),n&&n("Fixing bitrate to lowest level out of "+a.levels.length));else if("max"===e)Array.isArray(a.levels)&&a.levels.length>0&&(a.nextLevel=a.levels.length-1,r({bitrateFix:j(a.levels[a.levels.length-1])}),n&&n("Fixing bitrate to highest level out of "+a.levels.length));else if(null==e||isNaN(e)||e<0||!e)n&&n("Resetting fixing of bitrate."),a.nextLevel=-1,r({bitrateFix:null});else if("string"===typeof e)n&&n("Unknown string specified for bitrate lock. Please use a value of type number if a bitrate specified by kbps is intended.",e);else if(Array.isArray(a.levels)){for(var t=0;t<a.levels.length;t++)if(j(a.levels[t])===e)return a.nextLevel=t,n&&n("Fixing bitrate to HLS level "+t,a.levels),void r({bitrateFix:e});n&&n("Desired bitrate lock didn't match any bitrates specified in the hls.levels list. Not applied.",a.levels)}else n&&n("Found no HLS levels from where bitrate fixing can be applied.",a.levels)},capBitrate:function(e){if(a)if(isNaN(e)||e===1/0||null==e||e<0)n&&n("Resetting restrictions for bitrate."),a.autoLevelCapping=-1,r({bitrateCap:null});else if(Array.isArray(a.levels)){let t=!1;for(let i=0;i<a.levels.length;i++){const s=j(a.levels[i]);if(s===e){a.autoLevelCapping=i,r({bitrateCap:j(a.levels[i])}),n&&n("Desired bitrate cap "+e+" is equal to level on index "+i+" in hls.js.",a.levels),t=!0;break}if(s>e){i>0?(a.autoLevelCapping=i-1,r({bitrateCap:j(a.levels[i-1])}),n&&n("Desired bitrate cap "+e+" is closest to level on index "+(i-1)+" in hls.js.",a.levels)):(a.autoLevelCapping=0,n&&n("Desired bitrate cap "+e+" appears to be lower than the lowest HLS level. Aligning to lowest level.",a.levels),r({bitrateCap:j(a.levels[0])})),t=!0;break}}t||n&&n("Desired bitrate cap appears to be higher than the higher HLS level. Not applicable.",a.levels)}else n&&n("Found no HLS levels from where bitrate capping can be applied.",a.levels)}}},C=r("./src/replay/components/player/VideoStreamer/BasicVideoStreamer/basicVideoEventHandlers.js");const N=i.a.ErrorDetails,F=[N.MANIFEST_LOAD_ERROR,N.MANIFEST_LOAD_TIMEOUT,N.LEVEL_LOAD_ERROR,N.LEVEL_LOAD_TIMEOUT,N.AUDIO_TRACK_LOAD_ERROR,N.AUDIO_TRACK_LOAD_TIMEOUT,N.FRAG_LOAD_ERROR,N.FRAG_LOOP_LOADING_ERROR,N.FRAG_LOAD_TIMEOUT,N.KEY_LOAD_ERROR,N.KEY_LOAD_TIMEOUT],M=[N.MANIFEST_PARSING_ERROR,N.MANIFEST_INCOMPATIBLE_CODECS_ERROR,N.FRAG_DECRYPT_ERROR,N.BUFFER_ADD_CODEC_ERROR,N.FRAG_PARSING_ERROR];var I=({streamer:e,videoElement:t,instanceKeeper:r,streamRangeHelper:n,configuration:a,applyProperties:o,updateStreamState:l,log:c})=>{const u=Object(C.a)({streamer:e,videoElement:t,streamRangeHelper:n,configuration:a,log:c,applyProperties:o,updateStreamState:l}),d=u.videoElementEventHandlers,f=u.pauseStreamRangeUpdater;let p,v={setStage:e=>{},getStage:()=>{}};function E(n){c&&c("hlsjs.error");const o=function(e,t){const r=t.fatal?"FATAL":"WARNING",n=(t&&t.details&&F.indexOf(t.details)>=0?"STREAM_ERROR_DOWNLOAD":M.indexOf(t.details)>=0&&"STREAM_ERROR_DECODE")||"STREAM_ERROR";return new s.a(n,"hlsjs",function(e){const t=(e.type?e.type+"/":"")+(e.details||"");return"string"===typeof e.reason?t+": "+e.reason:t}(t),r,t)}(v.getStage(),n),u=r.hls,d=a&&a.hlsjs&&a.hlsjs.autoRecoverStreamErrors;u&&"FATAL"===o.severity&&(e.props.onPlaybackError&&e.props.onPlaybackError(o),t.error&&l({error:t.error}),d&&n.type===i.a.ErrorTypes.NETWORK_ERROR?u.startLoad():d&&n.type===i.a.ErrorTypes.MEDIA_ERROR?(p&&Date.now()-1e3<p?(p=void 0,u.swapAudioCodec()):p=Date.now(),u.recoverMediaError()):(v.setStage("dead"),l({playState:"inactive",isBuffering:!1,isSeeking:!1}))),f.stop()}const m={[i.a.Events.ERROR]:(e,t)=>{switch(t.details){case i.a.ErrorDetails.BUFFER_STALLED_ERROR:l({isBuffering:!0}),"started"===v.getStage()&&l({playState:"buffering"});break;case i.a.ErrorDetails.BUFFER_SEEK_OVER_HOLE:case i.a.ErrorDetails.BUFFER_NUDGE_ON_STALL:break;case i.a.ErrorDetails.MANIFEST_PARSING_ERROR:t.url&&!t.url.endsWith("undefined")&&E(t);break;default:E(t)}},[i.a.Events.MANIFEST_LOADING]:()=>{if(c&&c("hlsjs.loading"),p=void 0,"new"===v.getStage()){if(v.setStage("starting"),e.props.initialPlaybackProps){const t=e.props.initialPlaybackProps,r=t.isMuted,n=t.volume;o({isMuted:r,volume:n})}l({playState:"starting",isBuffering:!0,volume:t.volume,isMuted:t.muted,isPipAvailable:u.isPipAvailable()})}},[i.a.Events.FRAG_BUFFERED]:()=>{l({isBuffering:!1})},[i.a.Events.MANIFEST_PARSED]:()=>{if(c&&c("hlsjs.parsed"),e.props.initialPlaybackProps){const r=e.props.initialPlaybackProps,n=r.isPaused,a=r.bitrateFix,i=r.bitrateCap;n&&t.pause(),o({bitrateFix:a,bitrateCap:i}),null==a&&l({bitrateFix:null}),null==i&&l({bitrateCap:null})}else l({bitrateFix:null,bitrateCap:null});l(n.calculateNewState())}};r.subscribers.push((function(e,t){Object.entries(m).forEach(([r,n])=>{e[t](r,n)})}));return{videoElementEventHandlers:{onCanPlay:d.onCanPlay,onPlaying:d.onPlaying,onPause:d.onPause,onSeeking:d.onSeeking,onSeeked:d.onSeeked,onDurationChange:d.onDurationChange,onTimeUpdate:d.onTimeUpdate,onVolumeChange:d.onVolumeChange,onProgress:d.onProgress,onEnded:d.onEnded},pauseStreamRangeUpdater:f,setLifeCycleManager:function(e){v=e,u.setLifeCycleManager(e)}}};const U=Object(n.a)("HlsjsVideoStreamer",(function(e,t,r,n){const a={videoElement:r,subscribers:[]},i=v(r,a,t),s=m(a),o=Object(g.a)(e),l=w(r,a,o,n),c=R(a,o),u=x(e,a,o,Object(h.a)(window,"bitrateManager").log),d=Object(b.a)(r,i,l,c,u),p=Object(h.a)(window,"videoEvents").log,E=I({streamer:e,videoElement:r,instanceKeeper:a,streamRangeHelper:i,configuration:t,applyProperties:d,updateStreamState:o,log:p}),S=E.videoElementEventHandlers,y=E.setLifeCycleManager,O=Object(T.a)(o,E.pauseStreamRangeUpdater,Object(h.a)(window,"lifecycle").log);y(O);const A=O.startPlaybackSession,L=O.endPlaybackSession,D=a,P=k.a;return Promise.resolve({cleanup:function(){return l.cleanup(),O.cleanup(),f(a)},render:P,textTrackManager:l,audioTrackManager:c,thirdPartyPlayer:D,applyProperties:d,handleSourceChange:s,startPlaybackSession:A,endPlaybackSession:L,videoElementEventHandlers:S})}));t.default=U}}]);
//# sourceMappingURL=48.db0fdb463ccd482b26a4.js.map