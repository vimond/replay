(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{"./src/replay/components/player/VideoStreamer/HlsjsVideoStreamer/HlsjsVideoStreamer.js":function(e,t,r){"use strict";r.r(t);var n=r("./src/replay/components/player/VideoStreamer/common/createVideoStreamerComponent.js"),a=r("./node_modules/hls.js/dist/hls.js"),i=r.n(a),o=r("./src/replay/components/player/VideoStreamer/types.js");function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e,t){const r=e.hls;r&&e.subscribers.forEach(e=>e(r,t))}function u(e,t){return new Promise((r,n)=>{if(i.a.isSupported()){const n=t&&t.hlsjs&&t.hlsjs.customConfiguration,a=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach((function(t){l(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({autoStartLoad:!1,debug:t&&"DEBUG"===t.logLevel,enableWorker:!1},n),o=new i.a(a);o.on(i.a.Events.MEDIA_ATTACHED,()=>{r(o)}),o.attachMedia(e)}else n(new o.a("STREAM_ERROR_TECHNOLOGY_UNSUPPORTED","hlsjs","Hls.js is not supported in this browser."))})}function d(e){const t=e.hls;return t?(t.stopLoad(),c(e,"off"),Promise.resolve(t.destroy())):Promise.resolve()}const f=new Date(0);var p=(e,t,r)=>{const n=r&&r.liveEdgeMargin||10;let a,o,s=0,l=!1;function c(){a=null,s=0,l=!1}const u={[i.a.Events.MANIFEST_LOADING]:()=>c,[i.a.Events.LEVEL_LOADED]:(e,t)=>{l=t.details.live,s=t.details.totalduration;const r=t.details&&t.details.fragments&&t.details.fragments[0]&&t.details.fragments[0].programDateTime;r&&(a=new Date(r))}};return t.subscribers.push((function(e,t){Object.entries(u).forEach(([r,n])=>{e[t](r,n),"on"===t&&(o=e)})})),{adjustForDvrStartOffset:function(){},calculateNewState:function(){let t;t=s?Math.max((e.currentTime||0)-Math.max(e.duration-s,0),0):e.currentTime||0;const r=s||e.duration,i=function(e,t,r){if(t instanceof Date&&!isNaN(t))return{absolutePosition:new Date(t.getTime()+1e3*r),absoluteStartPosition:t};if(e){const e=new Date,t=new Date(e.getTime()-1e3*r);return{absolutePosition:e,absoluteStartPosition:t}}return{absolutePosition:f,absoluteStartPosition:f}}(l,a,t),c=i.absolutePosition,u=i.absoluteStartPosition;return{position:t,duration:r,playMode:function(e,t){return t?e===1/0||0===e||e<100?"live":"livedvr":"ondemand"}(r,l),isAtLiveEdge:o&&function(e,t,r,n){return!!r&&(e.liveSyncPosition?t.currentTime>e.liveSyncPosition-n:e.config&&e.config.liveSyncDuration?t.currentTime>t.duration-(e.config.liveSyncDuration+n):!(!e.config||!e.config.liveSyncDurationCount)&&t.currentTime>t.duration-(10*e.config.liveSyncDurationCount+n))}(o,e,l,n),absolutePosition:c,absoluteStartPosition:u}},setPosition:function(t){isNaN(t)||t===1/0||isNaN(e.duration)||e.duration===1/0||(e.currentTime=s?t+e.duration-s:t)},gotoLive:function(){l&&o&&(o.liveSyncPosition?e.currentTime=o.liveSyncPosition:o.config&&o.config.liveSyncDuration?e.currentTime=e.duration-(o.config.liveSyncDuration+n):o.config&&o.config.liveSyncDurationCount?e.currentTime=e.duration-(10*o.config.liveSyncDurationCount+n):e.currentTime=e.duration-n)}}},v=r("./src/replay/components/player/VideoStreamer/common/sourceNormalizer.js");var E=e=>(t,r)=>{const n=e.videoElement;d(e);const a=Object(v.a)(t.source);return a?u(n,t.configuration).then(t=>(e.hls=t,c(e,"on"),new Promise((e,r)=>{const n=()=>{t.off(i.a.Events.MANIFEST_PARSED,n);try{a.startPosition?t.startLoad(a.startPosition):t.startLoad(),e()}catch(s){r(new o.a("STREAM_ERROR","hlsjs","Stream load start failed.","FATAL",s))}};try{t.on(i.a.Events.MANIFEST_PARSED,n),t.loadSource(a.streamUrl)}catch(s){r(new o.a("STREAM_ERROR","hlsjs","Stream load failed.","FATAL",s))}}))):Promise.resolve()},m=r("./src/replay/components/player/VideoStreamer/common/filteredStreamStateUpdater.js"),g=r("./src/replay/components/player/VideoStreamer/common/propertyApplier.js"),b=r("./src/replay/components/player/VideoStreamer/common/playbackLifeCycleManager.js"),T=r("./src/replay/components/player/VideoStreamer/common/renderers.js"),k=r("./src/replay/components/player/VideoStreamer/common/logger.js");const S=(e,t)=>!e&&!t||e===t,h=(e,t)=>!e||!t||e===t;var y=(e,t)=>{let r,n=[];function a(){if(r){const e=(e=>{const t=[];return e?e.filter(e=>{const r="".concat(e.lang||"","!").concat(e.name||""),n=t.indexOf(r)<0;return n&&t.push(r),n}).map(e=>({id:e.id,language:e.lang||"unknown",kind:"",label:e.name||"unknown",origin:"in-stream"})):[]})(r.audioTracks);((e,t)=>{if(e.length===t.length){for(let r=0;r<e.length;r++)if(!S(e[r].id,t[r].id)||!S(e[r].language,t[r].language)||!S(e[r].label,t[r].label))return!0;return!1}return!0})(e,n)&&(n=e)}}function o(){let e=null;if(r){const t=r.audioTracks.filter(e=>e.id===r.audioTrack)[0];if(t){const r=t.name,a=t.lang;e=n.filter(({label:e,language:t})=>e===r&&t===a)[0]}}t({audioTracks:n,currentAudioTrack:e})}function s(){a(),o()}function l(){n=[]}const c={[i.a.Events.MANIFEST_LOADING]:()=>l,[i.a.Events.MANIFEST_PARSED]:s,[i.a.Events.AUDIO_TRACK_SWITCHED]:function(){a(),o()}};return e.subscribers.push((function(e,t){Object.entries(c).forEach(([n,a])=>{e[t](n,a),"on"===t&&(r=e)})})),{cleanup:()=>{},handleSourceChange:function(){s()},handleSelectedAudioTrackChange:function(e){const t=e;if(r&&r.audioTracks&&t){const e=(r.audioTracks[r.audioTrack]||{}).groupId,n=r.audioTracks.filter(r=>h(r.groupId,e)&&h(r.name,t.label)&&h(r.lang,t.language))[0];n&&(r.audioTrack=n.id)}}}},R=r("./src/replay/components/common.js");const A=["disabled","hidden","showing"];function O(e){const t=e.mode;return"number"===typeof t?A[t]:t}function L(e,t){e.mode="number"===typeof e.mode?A.indexOf(t):t}function P(e,t){return Number.isNaN(e)&&Number.isNaN(t)||null==e&&null==t||e===t}function D(e,t,r){return{id:e,kind:r.kind||"",label:r.label||"",language:r.language||"",origin:t}}var _=(e,t,r,n)=>{let a=[],i=null,o=b.b,s=0;const l=window.VTTCue||window.TextTrackCue;function c(){i=a.filter(e=>null!=e.videoElementTrack&&"showing"===O(e.videoElementTrack)).map(e=>e.selectableTrack)[0];const e=a.filter(e=>e.selectableTrack).map(e=>e.selectableTrack);Object(R.i)(e,o)?r({currentTextTrack:i,textTracks:o}):(o=e,r({currentTextTrack:i,textTracks:e}))}function u(t){if(Array.isArray(t)){e.textTracks.removeEventListener("addtrack",p),e.textTracks.removeEventListener("removetrack",E);const r=t.filter(e=>{const t=a.filter(t=>function(e,t){if(e&&t){if(e.cues&&t.cues){const r=e.cues,n=t.cues;if(r.length===n.length){if(r.filter((e,t)=>e.start===n[t].start&&e.end===n[t].end&&e.content===n[t].content).length!==r.length)return!1}}return P(e.language,t.language)&&P(e.kind,t.kind)&&P(e.label,t.label)&&P(e.src,t.src)}return P(e,t)}(t.sourceTrack,e)&&!t.isBlacklisted);if(0===t.length)return!0;{const r=t[0];return r.sourceTrack=e,r.isBlacklisted=!1,r.isLoaded=!0,!1}}).map(t=>{const r=++s;if(Array.isArray(t.cues)){const n=t.cues,a=e.addTextTrack("subtitles",t.label,t.language);return n.forEach(e=>{a.addCue(new l(e.start,e.end,e.content))}),{id:r,sourceTrack:t,isBlacklisted:!1,videoElementTrack:a,selectableTrack:D(r,"side-loaded",a),loadPromise:Promise.resolve(a),isLoaded:!0}}{const e={src:t.src,srclang:t.language,kind:t.kind||"subtitles",label:t.label},n=new Promise(t=>{e.onRef=e=>{const r=e;if(r){L(r.track,"hidden");const e=()=>{r.removeEventListener("load",e),r.removeEventListener("error",n),t(r.track)},n=a=>{r.removeEventListener("load",e),r.removeEventListener("error",n),t()};r.addEventListener("load",e),r.addEventListener("error",n)}}}),a={id:r,sourceTrack:t,isBlacklisted:!1,videoElementTrack:void 0,selectableTrack:void 0,trackElementData:e,loadPromise:n,isLoaded:!1};return n.then(e=>{null!=e&&(a.videoElementTrack=e,a.selectableTrack=D(r,"side-loaded",e)),a.isLoaded=!0}),a}});return a=a.concat(r),n(a.filter(e=>e.trackElementData&&!e.isBlacklisted).map(e=>e.trackElementData)),Promise.all(r.map(e=>e.loadPromise)).then(()=>{e.textTracks.addEventListener("addtrack",p),e.textTracks.addEventListener("removetrack",E),c()})}return Promise.resolve()}function d(e){if(0===e.length&&0===a.length)return;const t=[];for(let n=0;n<e.length;n++)t.push(e[n]);const r=a.filter(e=>t.indexOf(e.videoElementTrack)>=0);if(t.length>r.length){const e=t.filter(e=>{return("metadata"!==(t=e).kind&&!("inBandMetadataTrackDispatchType"in t)||t.cues&&t.cues.length||t.label||t.language)&&0===r.filter((function(t){return e===t.videoElementTrack})).length;var t}).map(e=>{const t=++s;return{id:t,sourceTrack:null,videoElementTrack:e,isBlacklisted:!1,selectableTrack:D(t,"in-stream",e),isLoaded:!0}});a=r.concat(e)}else a=r}function f(t){d(e.textTracks),a.forEach(e=>{if((t||null!=e.sourceTrack)&&(e.isBlacklisted=!0),null!=e.videoElementTrack&&t){const t=e.videoElementTrack;if(t.cues)for(;t.cues.length;)t.removeCue(t.cues[0]);L(t,"disabled")}e.selectableTrack=null}),o=b.b,n([])}function p(){d(e.textTracks),c()}function E(){d(e.textTracks),c()}return e.textTracks.addEventListener("addtrack",p),e.textTracks.addEventListener("removetrack",E),{handleSelectedTextTrackChange:function(e){if(a.filter(e=>e.videoElementTrack&&"showing"===O(e.videoElementTrack)).forEach(e=>e.videoElementTrack&&L(e.videoElementTrack,"hidden")),e){t.hls&&(t.hls.subtitleDisplay=!0);const r=a.filter(t=>t.selectableTrack===e)[0];r&&r.videoElementTrack&&L(r.videoElementTrack,"showing")}else t.hls&&(t.hls.subtitleDisplay=!1);c()},handleTextTracksPropChange:function(e){f(!1),u(e.source&&Array.isArray(e.textTracks)?e.textTracks:[])},handleSourcePropChange:function(t){d(e.textTracks);const r=t.source&&Array.isArray(t.textTracks)?t.textTracks:[],n=Object(v.a)(t.source);n&&n.textTracks?u(r.concat(n.textTracks)):u(r)},clear:function(){f(!0)},cleanup:function(){e.textTracks.removeEventListener("addtrack",p),e.textTracks.removeEventListener("removetrack",E)}}};function j(e){return e&&Math.ceil(e.bitrate/1e3)||0}var w=(e,t,r,n)=>{let a,o=[];function s(e,t){if(a){let s=Array.isArray(a.levels)?a.levels.map(j):[];Object(R.i)(o,s)&&(s=o);const l=e===i.a.Events.LEVEL_SWITCHED?t.level:-1===a.currentLevel?a.startLevel:a.currentLevel;if(-1===l)n&&n("No hls.js level reported currently or selected for start."),r({bitrates:s});else{const e=j(a.levels[l]);r({currentBitrate:e,bitrates:s})}}}const l={[i.a.Events.MANIFEST_LOADING]:()=>{o=[]},[i.a.Events.MANIFEST_PARSED]:s,[i.a.Events.LEVEL_SWITCHED]:s,[i.a.Events.LEVEL_UPDATED]:s};return t.subscribers.push((function(e,t){Object.entries(l).forEach(([r,n])=>{e[t](r,n),"on"===t&&(a=e)})})),{fixBitrate:function(e){if(a)if("min"===e)Array.isArray(a.levels)&&a.levels.length>0&&(a.nextLevel=0,r({bitrateFix:j(a.levels[0])}),n&&n("Fixing bitrate to lowest level out of "+a.levels.length));else if("max"===e)Array.isArray(a.levels)&&a.levels.length>0&&(a.nextLevel=a.levels.length-1,r({bitrateFix:j(a.levels[a.levels.length-1])}),n&&n("Fixing bitrate to highest level out of "+a.levels.length));else if(null==e||isNaN(e)||e<0||!e)n&&n("Resetting fixing of bitrate."),a.nextLevel=-1,r({bitrateFix:null});else if("string"===typeof e)n&&n("Unknown string specified for bitrate lock. Please use a value of type number if a bitrate specified by kbps is intended.",e);else if(Array.isArray(a.levels)){for(var t=0;t<a.levels.length;t++)if(j(a.levels[t])===e)return a.nextLevel=t,n&&n("Fixing bitrate to HLS level "+t,a.levels),void r({bitrateFix:e});n&&n("Desired bitrate lock didn't match any bitrates specified in the hls.levels list. Not applied.",a.levels)}else n&&n("Found no HLS levels from where bitrate fixing can be applied.",a.levels)},capBitrate:function(e){if(a)if(isNaN(e)||e===1/0||null==e||e<0)n&&n("Resetting restrictions for bitrate."),a.autoLevelCapping=-1,r({bitrateCap:null});else if(Array.isArray(a.levels)){let t=!1;for(let i=0;i<a.levels.length;i++){const o=j(a.levels[i]);if(o===e){a.autoLevelCapping=i,r({bitrateCap:j(a.levels[i])}),n&&n("Desired bitrate cap "+e+" is equal to level on index "+i+" in hls.js.",a.levels),t=!0;break}if(o>e){i>0?(a.autoLevelCapping=i-1,r({bitrateCap:j(a.levels[i-1])}),n&&n("Desired bitrate cap "+e+" is closest to level on index "+(i-1)+" in hls.js.",a.levels)):(a.autoLevelCapping=0,n&&n("Desired bitrate cap "+e+" appears to be lower than the lowest HLS level. Aligning to lowest level.",a.levels),r({bitrateCap:j(a.levels[0])})),t=!0;break}}t||n&&n("Desired bitrate cap appears to be higher than the higher HLS level. Not applicable.",a.levels)}else n&&n("Found no HLS levels from where bitrate capping can be applied.",a.levels)}}},x=r("./src/replay/components/player/VideoStreamer/BasicVideoStreamer/basicVideoEventHandlers.js");const C=i.a.ErrorDetails,N=[C.MANIFEST_LOAD_ERROR,C.MANIFEST_LOAD_TIMEOUT,C.LEVEL_LOAD_ERROR,C.LEVEL_LOAD_TIMEOUT,C.AUDIO_TRACK_LOAD_ERROR,C.AUDIO_TRACK_LOAD_TIMEOUT,C.FRAG_LOAD_ERROR,C.FRAG_LOOP_LOADING_ERROR,C.FRAG_LOAD_TIMEOUT,C.KEY_LOAD_ERROR,C.KEY_LOAD_TIMEOUT],F=[C.MANIFEST_PARSING_ERROR,C.MANIFEST_INCOMPATIBLE_CODECS_ERROR,C.FRAG_DECRYPT_ERROR,C.BUFFER_ADD_CODEC_ERROR,C.FRAG_PARSING_ERROR];var M=({streamer:e,videoElement:t,instanceKeeper:r,streamRangeHelper:n,configuration:a,applyProperties:s,updateStreamState:l,log:c})=>{const u=Object(x.a)({streamer:e,videoElement:t,streamRangeHelper:n,configuration:a,log:c,applyProperties:s,updateStreamState:l}),d=u.videoElementEventHandlers,f=u.pauseStreamRangeUpdater;let p={setStage:e=>{},getStage:()=>{}};function v(r){c&&c("hlsjs.error");const n=function(e,t){const r=t.fatal?"FATAL":"WARNING",n=(t&&t.details&&N.indexOf(t.details)>=0?"STREAM_ERROR_DOWNLOAD":F.indexOf(t.details)>=0&&"STREAM_ERROR_DECODE")||"STREAM_ERROR";return new o.a(n,"hlsjs",function(e){const t=(e.type?e.type+"/":"")+(e.details||"");return"string"===typeof e.reason?t+": "+e.reason:t}(t),r,t)}(p.getStage(),r);e.props.onPlaybackError&&e.props.onPlaybackError(n),t.error&&l({error:t.error}),"FATAL"===n.severity&&(p.setStage("dead"),l({playState:"inactive",isBuffering:!1,isSeeking:!1})),f.stop()}const E={[i.a.Events.ERROR]:(e,t)=>{switch(t.details){case i.a.ErrorDetails.BUFFER_STALLED_ERROR:l({isBuffering:!0}),"started"===p.getStage()&&l({playState:"buffering"});break;case i.a.ErrorDetails.BUFFER_SEEK_OVER_HOLE:case i.a.ErrorDetails.BUFFER_NUDGE_ON_STALL:break;case i.a.ErrorDetails.MANIFEST_PARSING_ERROR:t.url&&!t.url.endsWith("undefined")&&v(t);break;default:v(t)}},[i.a.Events.MANIFEST_LOADING]:()=>{if(c&&c("hlsjs.loading"),"new"===p.getStage()){if(p.setStage("starting"),e.props.initialPlaybackProps){const t=e.props.initialPlaybackProps,r=t.isMuted,n=t.volume;s({isMuted:r,volume:n})}l({playState:"starting",isBuffering:!0,volume:t.volume,isMuted:t.muted,isPipAvailable:u.isPipAvailable()})}},[i.a.Events.FRAG_BUFFERED]:()=>{l({isBuffering:!1})},[i.a.Events.MANIFEST_PARSED]:()=>{if(c&&c("hlsjs.parsed"),e.props.initialPlaybackProps){const r=e.props.initialPlaybackProps,n=r.isPaused,a=r.bitrateFix,i=r.bitrateCap;n&&t.pause(),s({bitrateFix:a,bitrateCap:i}),null==a&&l({bitrateFix:null}),null==i&&l({bitrateCap:null})}else l({bitrateFix:null,bitrateCap:null});l(n.calculateNewState())}};return r.subscribers.push((function(e,t){Object.entries(E).forEach(([r,n])=>{e[t](r,n)})})),{videoElementEventHandlers:{onCanPlay:d.onCanPlay,onPlaying:d.onPlaying,onPause:d.onPause,onSeeking:d.onSeeking,onSeeked:d.onSeeked,onDurationChange:d.onDurationChange,onTimeUpdate:d.onTimeUpdate,onVolumeChange:d.onVolumeChange,onProgress:d.onProgress,onEnded:d.onEnded,onError:d.onError},pauseStreamRangeUpdater:f,setLifeCycleManager:function(e){p=e,u.setLifeCycleManager(e)}}};const I=Object(n.a)("HlsjsVideoStreamer",(function(e,t,r,n){const a={videoElement:r,subscribers:[]},i=p(r,a,t),o=E(a),s=Object(m.a)(e),l=_(r,a,s,n),c=y(a,s),u=w(e,a,s,Object(k.a)(window,"bitrateManager").log),f=Object(g.a)(r,i,l,c,u),v=Object(k.a)(window,"videoEvents").log,S=M({streamer:e,videoElement:r,instanceKeeper:a,streamRangeHelper:i,configuration:t,applyProperties:f,updateStreamState:s,log:v}),h=S.videoElementEventHandlers,R=S.setLifeCycleManager,A=Object(b.a)(s,S.pauseStreamRangeUpdater,Object(k.a)(window,"lifecycle").log);R(A);const O=A.startPlaybackSession,L=A.endPlaybackSession,P=a,D=T.a;return Promise.resolve({cleanup:function(){return l.cleanup(),A.cleanup(),d(a)},render:D,textTrackManager:l,audioTrackManager:c,thirdPartyPlayer:P,applyProperties:f,handleSourceChange:o,startPlaybackSession:O,endPlaybackSession:L,videoElementEventHandlers:h})}));t.default=I}}]);
//# sourceMappingURL=48.d2054bfdd82bd3c54d47.js.map